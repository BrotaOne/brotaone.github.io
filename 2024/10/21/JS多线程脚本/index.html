<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>JS 多线程脚本 | Hexo</title><meta name="description" content="JS 多线程脚本 - Brota Gong"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/theme.css"><link rel="search" type="application/opensearchdescription+xml" href="/atom.xml" title="Hexo"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head><body><div class="wrap"><header><h1 class="branding"><a href="/" title="Hexo"><img class="logo-image" src="/logo.png" alt="logo"></a></h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">HOME</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives" target="_self">ARCHIVES</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/BrotaOne" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">JS 多线程脚本</h1><div class="post-info"><a></a>2024-10-21</div><div class="post-content"><h2 id="脚本意义"><a href="#脚本意义" class="headerlink" title="脚本意义"></a>脚本意义</h2><p>在一个组件库的项目中，因为支持单独安装每个组件，因此目录下有多个 package，所以在升级依赖的时候有些重复的操作，如果一个个改太浪费时间了，即使使用<code>lerna run --stream --sort</code> 这种形式，也可能因为一个 package 运行报错导致全部停止，而且第二次运行的时候又得重头来，还是比较浪费时间的</p>
<p>于是就自己写了个脚本，可以多进程同时在多个目录下运行，pnpm 下的命令（当然换成shell也是可以的）</p>
<h2 id="todo"><a href="#todo" class="headerlink" title="todo"></a>todo</h2><p>写的时间有点久，有些地方没有写好，比如没有补上 error 的打印，以及下次还是重头来，如果增加每次检查是否有进度文件，等下次用到的时候再优化下。</p>
<p>源码一可以在一个文件里就把主、从进程的逻辑写完，源码二就得单独写个文件了，不过源码一也是比较久之前的代码了，还是以 node 服务为例，</p>
<h2 id="源码一"><a href="#源码一" class="headerlink" title="源码一"></a>源码一</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cluster <span class="keyword">from</span> <span class="string">&#x27;cluster&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> os <span class="keyword">from</span> <span class="string">&#x27;os&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (cluster.<span class="property">isMaster</span>) &#123;</span><br><span class="line">​    <span class="keyword">const</span> numCPUs = os.<span class="title function_">cpus</span>().<span class="property">length</span>;</span><br><span class="line">​    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; numCPUs; i++) &#123;</span><br><span class="line">​        cluster.<span class="title function_">fork</span>(); <span class="comment">// 创建工作进程</span></span><br><span class="line">​    &#125;</span><br><span class="line">​    cluster.<span class="title function_">on</span>(<span class="string">&#x27;exit&#x27;</span>, <span class="function">(<span class="params">worker, code, signal</span>) =&gt;</span> &#123;</span><br><span class="line">​        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Worker</span> $&#123;*worker*.<span class="property">process</span>.<span class="property">pid</span>&#125; died);</span><br><span class="line">​    &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">​    http.<span class="title function_">createServer</span>(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">​        res.<span class="title function_">writeHead</span>(<span class="number">200</span>);</span><br><span class="line">​        res.<span class="title function_">end</span>(<span class="string">&#x27;Hello World\n&#x27;</span>);</span><br><span class="line">​    &#125;).<span class="title function_">listen</span>(<span class="number">8000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="源码二"><a href="#源码二" class="headerlink" title="源码二"></a>源码二</h2><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Worker</span>, isMainThread, parentPort, workerData &#125; <span class="keyword">from</span> <span class="string">&#x27;worker_threads&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; execSync &#125; <span class="keyword">from</span> <span class="string">&#x27;child_process&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable constant_">PATH</span> = <span class="string">&#x27;./packages&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">clusterDo</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="title function_">execSync</span>(<span class="string">&#x27;pnpm lint --fix&#x27;</span>, &#123;</span><br><span class="line">            <span class="attr">cwd</span>: workerData.<span class="property">path</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        parentPort.<span class="title function_">postMessage</span>(workerData.<span class="property">path</span> + <span class="string">&#x27;: success&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        parentPort.<span class="title function_">postMessage</span>(workerData.<span class="property">path</span> + <span class="string">&#x27;: failed&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleMessage</span> = (<span class="params">fn, errors</span>) =&gt; <span class="function">(<span class="params">path</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> name = path?.<span class="title function_">split</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (name?.[<span class="number">1</span>]?.<span class="title function_">includes</span>(<span class="string">&#x27;failed&#x27;</span>)) &#123;</span><br><span class="line">        errors.<span class="title function_">push</span>(name?.[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">fn</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">doNext</span> = (<span class="params">countOne, cutOne, errors, getIdx, names, getNum, <span class="keyword">type</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> idx = <span class="title function_">getIdx</span>();</span><br><span class="line">    <span class="keyword">const</span> num = <span class="title function_">getNum</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;num: &#x27;</span>, num, idx, <span class="keyword">type</span>);</span><br><span class="line">    <span class="keyword">if</span> (idx &gt;= names.<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (num === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;errors: &#x27;</span>, errors);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> worker = <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="string">&#x27;./do.mjs&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">workerData</span>: &#123;</span><br><span class="line">            <span class="attr">path</span>: <span class="string">`<span class="subst">$&#123;PATH&#125;</span>/<span class="subst">$&#123;names[idx]&#125;</span>`</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">countOne</span>(<span class="keyword">type</span>);</span><br><span class="line"></span><br><span class="line">    worker.<span class="title function_">on</span>(</span><br><span class="line">        <span class="string">&#x27;message&#x27;</span>,</span><br><span class="line">        <span class="title function_">handleMessage</span>(<span class="function">() =&gt;</span> <span class="title function_">doNext</span>(countOne, cutOne, errors, getIdx, names, getNum), errors)</span><br><span class="line">    );</span><br><span class="line">    worker.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, doNext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">mainDo</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable constant_">MAX_THREAD</span> = <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">const</span> names = fs.<span class="title function_">readdirSync</span>(<span class="variable constant_">PATH</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Main thread starting...&#x27;</span>, names);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> idx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> num = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> errors = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">countOne</span> = <span class="keyword">type</span> =&gt; &#123;</span><br><span class="line">        idx++;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">type</span> === <span class="string">&#x27;new&#x27;</span>) &#123;</span><br><span class="line">            num++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">cutOne</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        num--;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">getNum</span> = (<span class="params"></span>) =&gt; num;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">getIdx</span> = (<span class="params"></span>) =&gt; idx;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (idx &lt; <span class="variable constant_">MAX_THREAD</span>) &#123;</span><br><span class="line">        <span class="title function_">doNext</span>(countOne, cutOne, errors, getIdx, names, getNum, <span class="string">&#x27;new&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isMainThread) &#123;</span><br><span class="line">        <span class="title function_">mainDo</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">clusterDo</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">main</span>();</span><br></pre></td></tr></table></figure>

</div></article></div></main><footer><div class="paginator"><a class="prev" href="/2024/11/15/hexo%E5%A6%82%E4%BD%95%E5%9C%A8push%E6%97%B6%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2/">prev</a><a class="next" href="/2023/12/25/Scheduler/">next</a></div><div class="copyright"><p>&copy; 2025 <a href="https://brotaone.github.io">Brota Gong</a>.<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a target="_blank"></a>.</p></div></footer></div></body></html>